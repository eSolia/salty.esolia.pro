<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Salty: Browser-Native Secure Text Encryption</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta
      property="og:title"
      content="Salty: Browser-Native Secure Text Encryption"
    >
    <meta property="og:url" content="https://salty.esolia.pro/">
    <meta
      property="og:description"
      content="Salty: Browser-Native Secure Text Encryption"
    >
    <!-- Tailwind CSS - Note: Dynamic CDN doesn't support SRI, consider using a specific version -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/duotone/style.css"
    />
    <!-- Fathom - beautiful, simple website analytics -->
    <script
      src="https://cdn.usefathom.com/script.js"
      data-site="SIBMOOOY"
      defer
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- / Fathom -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
      /* IBM Plex Sans JP font */
      @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap");
      body {
        font-family: "IBM Plex Sans JP", sans-serif;
      }
      /* Hide browser's native password reveal button */
      input[type="password"]::-ms-reveal,
      input[type="password"]::-ms-clear,
      input[type="password"]::-webkit-textfield-decoration-container {
        display: none;
      }
      /* For Edge specifically */
      input::-ms-reveal,
      input::-ms-clear {
        display: none;
      }
      /* Custom styles for the message box */
      .message-box {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4caf50; /* Green */
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .message-box.show {
        opacity: 1;
      }
      .message-box.error {
        background-color: #f44336; /* Red */
      }

      /* Modal styles */
      .modal {
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* Password visibility toggle */
      #togglePassword {
        display: none;
      }
      #togglePassword.show {
        display: block;
      }

      /* Password generator modal styles */
      .password-type-btn {
        cursor: pointer;
      }
      .password-type-btn.active {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .password-type-btn.active i {
        color: #3b82f6;
      }

      /* Password strength indicator styles */
      .strength-meter {
        height: 6px;
        background-color: #e5e7eb;
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .strength-meter-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease, background-color 0.3s ease;
        border-radius: 3px;
      }
      .strength-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 0.875rem;
      }
      .strength-label {
        font-weight: 600;
        transition: color 0.3s ease;
      }
      .strength-details {
        margin-top: 8px;
        padding: 12px;
        background-color: #f9fafb;
        border-radius: 6px;
        font-size: 0.875rem;
        border: 1px solid #e5e7eb;
      }
      .strength-warning {
        color: #dc2626;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .strength-suggestions {
        margin-top: 8px;
      }
      .strength-suggestions ul {
        list-style-type: disc;
        margin-left: 20px;
        color: #6b7280;
      }
      .strength-suggestions li {
        margin-top: 4px;
      }
      /* Breach warning styles */
      .breach-warning {
        margin-top: 12px;
        padding: 12px;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        display: flex;
        align-items: start;
        gap: 8px;
      }
      .breach-warning-icon {
        color: #dc2626;
        font-size: 1.25rem;
        flex-shrink: 0;
      }
      .breach-warning-content {
        flex: 1;
      }
      .breach-warning-title {
        color: #dc2626;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .breach-warning-text {
        color: #7f1d1d;
        font-size: 0.875rem;
        line-height: 1.4;
      }
      .breach-check-loading {
        margin-top: 8px;
        font-size: 0.875rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    </style>
  </head>

  <body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">
    <div id="messageBox" class="message-box"></div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal hidden">
      <div class="modal-content max-w-[65ch] mx-auto">
        <span class="close-button">&times;</span>
        <h1 class="text-3xl font-bold mb-4">Salty</h1>
        <p class="italic mb-4">Browser-Native Secure Text Encryption</p>
        <p class="mb-4">
          Salty makes it easy to send strongly-encrypted messages with a shared
          key. It provides encryption capabilities via the browser's Web Crypto
          API and uses <a
            href="http://base91.sourceforge.net"
            target="_blank"
            class="text-sky-600 hover:underline"
          >basE91</a> for portability.
        </p>
        <p class="mb-4">
          With Salty, you can encrypt a message as long as 185 characters and
          the resulting cipher will still fit in a tweet (~277 characters),
          making it ideal for encrypting tweets or other length-restricted
          communication. You can use it anywhere, though, with text of any
          length.
        </p>
        <h2 class="text-2xl font-semibold mb-3">Acknowledgments</h2>
        <p class="mb-4">
          Salty has been re-written in modern Typescript, but was inspired by <a
            href="http://github.com/neatnik/salty"
            target="_blank"
            class="text-sky-600 hover:underline"
          >Neatnik's PHP Salty</a>.
        </p>
      </div>
    </div>

    <!-- Password Generator Modal -->
    <div id="passwordGeneratorModal" class="modal hidden">
      <div class="modal-content" style="max-width: 500px">
        <span
          class="close-button"
          onclick="document.getElementById('passwordGeneratorModal').classList.add('hidden')"
        >&times;</span>
        <h2 class="text-3xl font-bold text-sky-700 mb-6">Password Generator</h2>

        <div class="mb-6">
          <label class="block text-lg font-semibold text-gray-700 mb-3"
          >Type</label>
          <div class="grid grid-cols-2 gap-3">
            <button
              type="button"
              id="dicewareBtn"
              class="password-type-btn active p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center transition"
            >
              <i
                class="ph-duotone ph-dice-five text-2xl mb-2 text-blue-600"
              ></i>
              <div class="font-semibold">Diceware</div>
              <div class="text-sm text-gray-600">
                Memorable word combinations
              </div>
            </button>
            <button
              type="button"
              id="randomBtn"
              class="password-type-btn p-4 border-2 border-gray-300 bg-white rounded-lg text-center transition hover:border-gray-400"
            >
              <i class="ph-duotone ph-shuffle text-2xl mb-2 text-gray-600"></i>
              <div class="font-semibold">Random</div>
              <div class="text-sm text-gray-600">
                Completely random characters
              </div>
            </button>
          </div>
        </div>

        <!-- Diceware Options -->
        <div id="dicewareOptions" class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2"
          >Word Count</label>
          <input
            type="range"
            id="wordCount"
            min="4"
            max="8"
            value="6"
            class="w-full"
          >
          <div class="flex justify-between text-sm text-gray-500">
            <span>4</span>
            <span id="wordCountDisplay" class="font-medium text-gray-700"
            >6 words</span>
            <span>8</span>
          </div>
        </div>

        <!-- Random Options -->
        <div id="randomOptions" class="mb-6 hidden">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
            >Length</label>
            <input
              type="range"
              id="passwordLength"
              min="8"
              max="32"
              value="16"
              class="w-full"
            >
            <div class="flex justify-between text-sm text-gray-500">
              <span>8</span>
              <span id="passwordLengthDisplay" class="font-medium text-gray-700"
              >16 characters</span>
              <span>32</span>
            </div>
          </div>

          <div class="space-y-2">
            <label class="flex items-center">
              <input type="checkbox" id="includeUppercase" checked class="mr-2">
              <span class="text-sm">Uppercase (A-Z)</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="includeLowercase" checked class="mr-2">
              <span class="text-sm">Lowercase (a-z)</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="includeNumbers" checked class="mr-2">
              <span class="text-sm">Numbers (0-9)</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="includeSymbols" checked class="mr-2">
              <span class="text-sm">Symbols (!@#$%^&*)</span>
            </label>
          </div>

          <!-- Excluded Symbols -->
          <div class="mt-4" id="excludedSymbolsSection" style="display: none">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Exclude Symbols
              <span class="text-xs text-gray-500 ml-1">
                (hard to type on mobile, etc.)
              </span>
            </label>
            <input
              type="text"
              id="excludedSymbols"
              class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-mono"
              placeholder="e.g., <>{}"
            >
            <p class="text-xs text-gray-500 mt-1">
              These symbols won't be used in generated passwords
            </p>
          </div>
        </div>

        <!-- Generated Password Display -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2"
          >Generated Password</label>
          <div
            class="relative bg-gray-50 p-4 rounded-lg border border-gray-300"
          >
            <input
              type="text"
              id="generatedPassword"
              readonly
              class="w-full bg-transparent border-none outline-none pr-20 font-mono"
              placeholder="Click generate button"
            >
            <button
              type="button"
              id="copyGeneratedPassword"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Copy
            </button>
          </div>
          <div
            id="generatedPasswordStrength"
            class="mt-2 text-sm text-gray-600"
          >
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
          <button
            type="button"
            id="generateBtn"
            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-medium"
          >
            <i class="ph-duotone ph-arrows-clockwise mr-2"></i>Generate
          </button>
          <button
            type="button"
            id="usePasswordBtn"
            class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <i class="ph-duotone ph-check-fat mr-2"></i>Use
          </button>
        </div>
      </div>
    </div>

    <header class="bg-sky-800 text-white p-4 shadow-md">
      <div class="container mx-auto flex justify-between items-center">
        <p class="flex items-center space-x-2">
          <a
            href="/en/"
            class="text-white hover:text-gray-300 font-bold text-lg rounded-md p-1 transition"
          >
            <img
              src="/img/symbol_white_bgtransparent.svg"
              alt="eSolia Symbol Logo"
              class="h-10 w-auto rounded-md"
            >
          </a>
        </p>
        <p class="flex items-center space-x-4">
          <strong class="text-gray-300">Languages:</strong>
          <a
            href="/en/"
            class="text-white hover:text-gray-300 font-bold rounded-md p-2 hover:bg-gray-700 transition"
          >English</a>
          <a
            href="/"
            class="text-white hover:text-gray-300 font-bold rounded-md p-2 hover:bg-gray-700 transition"
          >日本語</a>
        </p>
      </div>
    </header>

    <main class="container mx-auto p-6 flex-grow">
      <h1 class="text-4xl font-bold text-center text-sky-700 mb-8 mt-4">
        Salty Secure Text Encryption
      </h1>

      <p class="max-w-[65ch] mx-auto text-center text-lg mb-8 leading-relaxed">
        Enter a payload and provide a key below. Your payload can be unencrypted
        text, or a Salty-encrypted cipher (detected automatically).
      </p>

      <form
        id="saltyForm"
        method="POST"
        class="bg-white p-8 rounded-lg shadow-xl max-w-2xl mx-auto space-y-6 border border-blue-200"
      >
        <div>
          <label
            for="payload"
            class="block text-lg font-semibold text-gray-700 mb-2"
          >Payload</label>
          <textarea
            name="payload"
            id="payload"
            rows="8"
            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 text-base resize-y"
          ></textarea>
        </div>

        <div>
          <div class="flex justify-between items-end mb-2">
            <label
              for="key"
              class="block text-lg font-semibold text-gray-700"
            >Key</label>
            <button
              type="button"
              id="generatePasswordBtn"
              class="text-sm text-blue-600 hover:text-blue-700 font-medium"
            >
              <i class="ph-duotone ph-key mr-1"></i>Generate Password
            </button>
          </div>
          <div class="relative">
            <input
              type="password"
              name="key"
              id="key"
              class="w-full p-4 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 text-base"
              placeholder="Enter key for encryption/decryption"
            >
            <button
              type="button"
              id="togglePassword"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
              aria-label="Show/hide password"
            >
              <i class="ph-duotone ph-eye" id="toggleIcon"></i>
            </button>
          </div>
          <!-- Password strength indicator -->
          <div id="strengthIndicator" class="hidden">
            <div class="strength-meter">
              <div id="strengthMeterFill" class="strength-meter-fill"></div>
            </div>
            <div class="strength-info">
              <span id="strengthLabel" class="strength-label"></span>
              <span id="entropyInfo" class="text-gray-500"></span>
            </div>
            <div id="strengthDetails" class="strength-details hidden">
              <div id="strengthWarning" class="strength-warning"></div>
              <div id="strengthCrackTime" class="text-gray-600 mb-2"></div>
              <div id="strengthSuggestions" class="strength-suggestions"></div>
            </div>
          </div>
          <!-- Breach warning -->
          <div id="breachWarning" class="breach-warning hidden">
            <div class="breach-warning-icon">
              <i class="ph-duotone ph-warning-diamond"></i>
            </div>
            <div class="breach-warning-content">
              <div class="breach-warning-title" id="breachTitle"></div>
              <div class="breach-warning-text" id="breachText"></div>
            </div>
          </div>
          <!-- Breach check loading -->
          <div id="breachCheckLoading" class="breach-check-loading hidden">
            <div class="spinner"></div>
            <span>Checking for data breaches...</span>
          </div>
        </div>

        <!-- Grouped Go and Reset buttons -->
        <div
          class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6"
        >
          <button
            type="submit"
            class="w-full sm:w-1/2 bg-emerald-500 text-white py-3 px-6 rounded-lg font-semibold text-xl shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-300 ease-in-out transform hover:scale-105"
          >
            <i class="ph-duotone ph-fingerprint mr-2"></i>Go
          </button>
          <button
            type="button"
            id="resetFormBtn"
            class="w-full sm:w-1/2 bg-amber-500 text-white py-3 px-6 rounded-lg font-semibold text-xl shadow-md hover:bg-amber-600 focus:outline-none focus:ring-4 focus:ring-amber-300 transition duration-300 ease-in-out transform hover:scale-105"
          >
            <i class="ph-duotone ph-broom mr-2"></i>Reset
          </button>
        </div>
      </form>

      <div
        id="saltyResult"
        class="mt-12 bg-white p-8 rounded-lg shadow-xl max-w-2xl mx-auto border border-blue-200 hidden"
      >
        <!-- Results will be displayed here by JavaScript -->
      </div>
    </main>

    <footer class="bg-sky-800 text-white p-6 mt-8 shadow-inner">
      <div class="container mx-auto text-center">
        <h4 class="text-xl font-semibold mb-3">eSolia Inc.</h4>
        <p class="mb-2">
          Shiodome City Center 5F (Work Styling)<br>
          1-5-2 Higashi-Shimbashi, Minato-ku, Tokyo, Japan, 105-7105<br>
          <br>
          Tel: 03-4577-3380 (Main)<br>
          Fax: 03-4577-3309
        </p>
        <img
          src="/img/logo_horiz_white_bgtransparent.svg"
          alt="eSolia Logo"
          class="mx-auto mb-4 rounded-md"
        />
        <p>
          <button
            type="button"
            id="aboutSaltyBtn"
            class="bg-fuchsia-600 text-white py-2 px-5 rounded-lg hover:bg-fuchsia-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
          >
            More About Salty
          </button>
        </p>
      </div>
    </footer>

    <script type="module">
      // Import cryptographic functions from salty.ts
      import {
        salty_decrypt,
        salty_encrypt,
        salty_key,
      } from "/salty.ts";

      // Import password strength analyzer
      import {
        analyzePasswordStrength,
        getStrengthLevel,
      } from "/password-strength.ts";

      // Import HIBP checker
      import { checkPasswordBreach } from "/hibp-checker.ts";

      // Import password generator
      import {
        calculatePasswordEntropy,
        generatePassword,
        getExcludedSymbols,
        initializeDiceware,
        setExcludedSymbols,
      } from "/password-generator.ts";

      // This will be replaced by the server upon serving the HTML file.
      const INJECTED_SALT_HEX =
        "SALT_HEX_PLACEHOLDER_INJECTED_BY_SERVER";

      const saltyForm = document.getElementById("saltyForm");
      const payloadInput = document.getElementById("payload");
      const keyInput = document.getElementById("key");
      const saltyResultDiv = document.getElementById("saltyResult");
      const messageBox = document.getElementById("messageBox");
      const aboutSaltyBtn = document.getElementById("aboutSaltyBtn");
      const helpModal = document.getElementById("helpModal");
      const closeButton = helpModal.querySelector(".close-button");
      const resetFormBtn = document.getElementById("resetFormBtn"); // Get the new reset button
      const togglePassword = document.getElementById("togglePassword");
      const toggleIcon = document.getElementById("toggleIcon");

      // Flag for sharing UI mode
      let sharingUIMode = false;

      // Password strength indicator elements
      const strengthIndicator = document.getElementById(
        "strengthIndicator",
      );
      const strengthMeterFill = document.getElementById(
        "strengthMeterFill",
      );
      const strengthLabel = document.getElementById("strengthLabel");
      const entropyInfo = document.getElementById("entropyInfo");
      const strengthDetails = document.getElementById(
        "strengthDetails",
      );
      const strengthWarning = document.getElementById(
        "strengthWarning",
      );
      const strengthCrackTime = document.getElementById(
        "strengthCrackTime",
      );
      const strengthSuggestions = document.getElementById(
        "strengthSuggestions",
      );

      // Breach warning elements
      const breachWarning = document.getElementById("breachWarning");
      const breachTitle = document.getElementById("breachTitle");
      const breachText = document.getElementById("breachText");
      const breachCheckLoading = document.getElementById(
        "breachCheckLoading",
      );

      // Debounce timer for breach checking
      let breachCheckTimer = null;

      /**
       * Check password breach status with debouncing
       */
      async function checkBreachStatus(password) {
        if (!password || password.length < 8) {
          breachWarning.classList.add("hidden");
          breachCheckLoading.classList.add("hidden");
          return;
        }

        // Show loading state
        breachCheckLoading.classList.remove("hidden");
        breachWarning.classList.add("hidden");

        try {
          const result = await checkPasswordBreach(password);

          // Hide loading
          breachCheckLoading.classList.add("hidden");

          if (result.error) {
            // Don't show errors to avoid blocking user
            console.warn("Breach check error:", result.error);
            return;
          }

          if (result.isCompromised) {
            breachTitle.textContent =
              "This password has been compromised!";

            const breachMessage = result.breachCount === 1
              ? "This password was found in 1 data breach."
              : `This password was found in ${result.breachCount.toLocaleString()} data breaches.`;

            breachText.textContent =
              `${breachMessage} We strongly recommend choosing a different, unique password.`;
            breachWarning.classList.remove("hidden");
          } else {
            breachWarning.classList.add("hidden");
          }
        } catch (error) {
          // Hide loading on error
          breachCheckLoading.classList.add("hidden");
          console.error("Breach check failed:", error);
        }
      }

      /**
       * Update password strength indicator
       */
      function updateStrengthIndicator(password) {
        if (!password || sharingUIMode) {
          strengthIndicator.classList.add("hidden");
          return;
        }

        strengthIndicator.classList.remove("hidden");

        // Always use analyzePasswordStrength which now handles diceware detection
        const strength = analyzePasswordStrength(password);

        const level = getStrengthLevel(strength.score);

        // Update meter fill
        const percentage = (strength.score / 4) * 100;
        strengthMeterFill.style.width = `${percentage}%`;
        strengthMeterFill.style.backgroundColor = level.color;

        // Update labels
        strengthLabel.textContent = level.label;
        strengthLabel.style.color = level.color;
        entropyInfo.textContent = `Entropy: ${
          Math.round(strength.entropy)
        } bits`;

        // Update details
        if (
          strength.feedback.warning ||
          strength.feedback.suggestions.length > 0 || strength.score < 4
        ) {
          strengthDetails.classList.remove("hidden");

          // Warning
          if (strength.feedback.warning) {
            strengthWarning.textContent = strength.feedback.warning;
            strengthWarning.style.display = "block";
          } else {
            strengthWarning.style.display = "none";
          }

          // Crack time
          strengthCrackTime.textContent =
            `Estimated crack time: ${strength.crackTimeDisplay}`;

          // Suggestions
          if (strength.feedback.suggestions.length > 0) {
            const suggestionsList = strength.feedback.suggestions
              .map((s) => `<li>${s}</li>`)
              .join("");
            strengthSuggestions.innerHTML =
              `<ul>${suggestionsList}</ul>`;
            strengthSuggestions.style.display = "block";
          } else {
            strengthSuggestions.style.display = "none";
          }
        } else {
          strengthDetails.classList.add("hidden");
        }
      }

      /**
       * Displays a temporary message box for user feedback.
       * @param {string} message The message to display.
       * @param {boolean} isError True if it's an error message, false for success/info.
       */
      function showMessageBox(message, isError = false) {
        messageBox.textContent = message;
        messageBox.className = "message-box show"; // Reset classes
        if (isError) {
          messageBox.classList.add("error");
        }
        setTimeout(() => {
          messageBox.classList.remove("show");
        }, 3000); // Hide after 3 seconds
      }

      /**
       * Copies text to the clipboard.
       * Reads the text from a data attribute on the clicked element.
       * @param {Event} event The click event.
       */
      window.copyToClipboard = function (event) { // Attached to window object
        const textToCopy = event.currentTarget.dataset.textToCopy;
        if (!textToCopy) {
          showMessageBox("No text to copy.", true);
          return;
        }

        const textarea = document.createElement("textarea");
        textarea.value = textToCopy;
        textarea.style.position = "fixed"; // Avoid scrolling to bottom
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.focus(); // Ensure textarea is focused
        textarea.select();
        try {
          const successful = document.execCommand("copy");
          if (successful) {
            showMessageBox("Copied to clipboard!");
          } else {
            showMessageBox("Failed to copy to clipboard.", true);
          }
        } catch (err) {
          showMessageBox("Failed to copy to clipboard.", true);
        }
        document.body.removeChild(textarea);
      };

      // Function to format and display output
      function displayResult(type, content) {
        let html = "";
        saltyResultDiv.innerHTML = ""; // Clear previous results
        saltyResultDiv.classList.remove("hidden");

        if (type === "plaintext") {
          html +=
            `<p class="text-sm text-gray-500 mb-2"><span class="font-bold text-green-600">Auto-detected: unencrypted plaintext</span></p>`;
          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4">Shareable cipher</h3>`;
          html +=
            `<div class="relative bg-amber-50 p-4 rounded-lg border border-blue-200 mb-4">
                  <p class="output uncompressed break-all text-gray-800">${
              escapeHtml(content.encryptedFormatted)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(content.encryptedFormatted)
            }"
                          class="absolute top-2 right-2 bg-amber-200 text-sky-800 px-3 py-1 rounded-md text-xs hover:bg-amber-300 transition">
                    Copy
                  </button>
               </div>`;

          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4">Compressed version</h3>`;
          html +=
            `<div class="relative bg-amber-50 p-4 rounded-lg border border-blue-200">
                  <p class="output breakable compressed text-gray-800 break-words">${
              escapeHtml(content.encryptedCompressed)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(content.encryptedCompressed)
            }"
                          class="absolute top-2 right-2 bg-amber-200 text-sky-800 px-3 py-1 rounded-md text-xs hover:bg-amber-300 transition">
                    Copy
                  </button>
               </div>
               <p class="text-sm text-gray-500 mt-2">${content.encryptedCompressed.length} chars</p>`;

          // Add URL copy button
          const currentUrl = new URL(window.location.href);
          currentUrl.searchParams.set(
            "payload",
            encodeURIComponent(content.encryptedCompressed),
          );
          const shareableUrl = currentUrl.toString();

          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4 mt-6">Shareable URL</h3>`;
          html +=
            `<div class="relative bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <p class="output text-gray-800 break-all text-sm">${
              escapeHtml(shareableUrl)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(shareableUrl)
            }"
                          class="absolute top-2 right-2 bg-blue-200 text-blue-800 px-3 py-1 rounded-md text-xs hover:bg-blue-300 transition">
                    Copy URL
                  </button>
               </div>
               <p class="text-sm text-gray-500 mt-2">Share this URL to allow others to decrypt using the same key.</p>`;

          // Add QR code section
          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4 mt-6">QR Code</h3>`;
          html +=
            `<div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 text-center">
                  <button onclick="window.showQRCodeFromButton(event)" 
                          data-qr-url="${escapeHtml(shareableUrl)}"
                          class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    Show QR Code
                  </button>
                  <p class="text-sm text-gray-600 mt-2">Scan with smartphone to open encrypted content</p>
               </div>`;
        } else if (type === "encrypted") {
          html +=
            `<p class="text-sm text-gray-500 mb-2"><span class="font-bold text-purple-600">Auto-detected: Salty cipher</span></p>`;
          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4">Decrypted Result</h3>`;
          html +=
            `<div class="relative bg-green-50 p-4 rounded-lg border border-green-200">
                  <p class="output decrypted break-all text-gray-800">${
              escapeHtml(content.decrypted)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(content.decrypted)
            }"
                          class="absolute top-2 right-2 bg-green-200 text-green-800 px-3 py-1 rounded-md text-xs hover:bg-green-300 transition">
                    Copy
                  </button>
               </div>`;
        } else if (type === "error") {
          html +=
            `<p class="text-sm text-red-500 mb-2"><span class="font-bold">Error</span></p>`;
          html +=
            `<div class="bg-red-50 p-4 rounded-lg border border-red-200 text-red-700">
                    <p>${escapeHtml(content)}</p>
                 </div>`;
        }
        saltyResultDiv.innerHTML = html;
      }

      // Basic HTML escaping
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
          "`": "&#96;", // Escape backtick for safety in template literals
        };
        return text.replace(/[&<>"'`]/g, function (m) {
          return map[m];
        });
      }

      // Function to get query parameter by name
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Event listener for form submission
      saltyForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = payloadInput.value;
        const key = keyInput.value;

        if (!payload || !key) {
          displayResult("error", "Please enter both payload and key.");
          return;
        }

        try {
          const cryptoKey = await salty_key(key, INJECTED_SALT_HEX);

          // Step 1: Clean the input by removing potential Salty headers and spaces
          let cleanedPayload = payload
            .replace(/-- BEGIN SALTY ENCRYPTED MESSAGE --/g, "")
            .replace(/-- END SALTY ENCRYPTED MESSAGE --/g, "")
            .replace(/\n|\r| /g, "");

          let decryptedText = null;
          try {
            decryptedText = await salty_decrypt(
              cleanedPayload,
              cryptoKey,
            );
          } catch (e) {
            console.warn(
              "Decryption attempt threw an error (likely invalid ciphertext format for Web Crypto API):",
              e,
            );
            // If salty_decrypt throws, it's definitely not valid ciphertext for the key, proceed to encrypt.
          }

          if (decryptedText !== null && decryptedText !== "") { // Also check for non-empty decrypted text
            // If decryption was successful and returned non-empty text, display it as decrypted.
            displayResult("encrypted", { decrypted: decryptedText });
          } else {
            // If decryption failed or returned null/empty, assume it was plaintext and encrypt it.
            // Use the original payload for encryption, not the cleaned one.
            const encrypted = await salty_encrypt(payload, cryptoKey);

            const encryptedFormatted =
              "-- BEGIN SALTY ENCRYPTED MESSAGE --\n" +
              encrypted.match(/.{1,2}/g)?.join(" ") +
              "\n-- END SALTY ENCRYPTED MESSAGE --";

            displayResult("plaintext", {
              encryptedFormatted: encryptedFormatted,
              encryptedCompressed: encrypted,
            });
          }
        } catch (e) {
          console.error("Overall operation failed:", e);
          displayResult(
            "error",
            "An error occurred: " + (e.message || "Unknown error"),
          );
        }
      });

      // Event listener for password strength indicator and breach check
      keyInput.addEventListener("input", (event) => {
        const password = event.target.value;

        updateStrengthIndicator(password);

        // Show/hide password toggle based on input
        if (password.length > 0) {
          togglePassword.classList.add("show");
        } else {
          togglePassword.classList.remove("show");
        }

        // Debounce breach checking (500ms after user stops typing)
        if (breachCheckTimer) {
          clearTimeout(breachCheckTimer);
        }

        if (password.length >= 8 && !sharingUIMode) {
          breachCheckTimer = setTimeout(() => {
            checkBreachStatus(password);
          }, 500);
        } else {
          breachWarning.classList.add("hidden");
          breachCheckLoading.classList.add("hidden");
        }
      });

      // Password visibility toggle
      togglePassword.addEventListener("click", () => {
        const type = keyInput.getAttribute("type") === "password"
          ? "text"
          : "password";
        keyInput.setAttribute("type", type);

        // Toggle icon
        if (type === "password") {
          toggleIcon.classList.remove("ph-eye-slash");
          toggleIcon.classList.add("ph-eye");
        } else {
          toggleIcon.classList.remove("ph-eye");
          toggleIcon.classList.add("ph-eye-slash");
        }
      });

      // Event listener for the reset button
      resetFormBtn.addEventListener("click", () => {
        payloadInput.value = "";
        keyInput.value = "";
        saltyResultDiv.classList.add("hidden");
        strengthIndicator.classList.add("hidden");
        breachWarning.classList.add("hidden");
        breachCheckLoading.classList.add("hidden");
        togglePassword.classList.remove("show");

        // Clear breach check timer
        if (breachCheckTimer) {
          clearTimeout(breachCheckTimer);
        }

        // Reset sharing UI mode and restore normal UI
        if (sharingUIMode) {
          sharingUIMode = false;
          const generateBtn = document.getElementById(
            "generatePasswordBtn",
          );
          if (generateBtn) generateBtn.style.display = "";
        }

        // Clear URL parameters
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);

        showMessageBox("Form has been reset.");
      });

      // Handle the "About Salty" button click to open modal
      aboutSaltyBtn.addEventListener("click", () => {
        helpModal.classList.remove("hidden");
      });

      // Handle closing the modal
      closeButton.addEventListener("click", () => {
        helpModal.classList.add("hidden");
      });

      // Close modal if user clicks outside of it
      window.addEventListener("click", (event) => {
        if (event.target === helpModal) {
          helpModal.classList.add("hidden");
        }
        if (
          event.target ===
            document.getElementById("passwordGeneratorModal")
        ) {
          document.getElementById("passwordGeneratorModal").classList
            .add("hidden");
        }
      });

      // Password Generator functionality
      const passwordGeneratorModal = document.getElementById(
        "passwordGeneratorModal",
      );
      const generatePasswordBtn = document.getElementById(
        "generatePasswordBtn",
      );
      const dicewareBtn = document.getElementById("dicewareBtn");
      const randomBtn = document.getElementById("randomBtn");
      const dicewareOptions = document.getElementById(
        "dicewareOptions",
      );
      const randomOptions = document.getElementById("randomOptions");
      const wordCount = document.getElementById("wordCount");
      const wordCountDisplay = document.getElementById(
        "wordCountDisplay",
      );
      const passwordLength = document.getElementById("passwordLength");
      const passwordLengthDisplay = document.getElementById(
        "passwordLengthDisplay",
      );
      const generatedPassword = document.getElementById(
        "generatedPassword",
      );
      const generatedPasswordStrength = document.getElementById(
        "generatedPasswordStrength",
      );
      const copyGeneratedPassword = document.getElementById(
        "copyGeneratedPassword",
      );
      const generateBtn = document.getElementById("generateBtn");
      const usePasswordBtn = document.getElementById("usePasswordBtn");
      const excludedSymbolsInput = document.getElementById(
        "excludedSymbols",
      );
      const excludedSymbolsSection = document.getElementById(
        "excludedSymbolsSection",
      );
      const includeSymbolsCheckbox = document.getElementById(
        "includeSymbols",
      );

      let currentPasswordType = "diceware";

      // Open password generator modal
      generatePasswordBtn.addEventListener("click", () => {
        passwordGeneratorModal.classList.remove("hidden");
        generateBtn.click(); // Auto-generate on open
      });

      // Switch between diceware and random
      dicewareBtn.addEventListener("click", () => {
        if (currentPasswordType !== "diceware") {
          currentPasswordType = "diceware";
          dicewareBtn.classList.add(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          dicewareBtn.classList.remove("border-gray-300", "bg-white");
          randomBtn.classList.remove(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          randomBtn.classList.add("border-gray-300", "bg-white");
          dicewareOptions.classList.remove("hidden");
          randomOptions.classList.add("hidden");
          generateBtn.click(); // Auto-regenerate on type change
        }
      });

      randomBtn.addEventListener("click", () => {
        if (currentPasswordType !== "random") {
          currentPasswordType = "random";
          randomBtn.classList.add(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          randomBtn.classList.remove("border-gray-300", "bg-white");
          dicewareBtn.classList.remove(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          dicewareBtn.classList.add("border-gray-300", "bg-white");
          randomOptions.classList.remove("hidden");
          dicewareOptions.classList.add("hidden");
          generateBtn.click(); // Auto-regenerate on type change
        }
      });

      // Update sliders and auto-regenerate
      wordCount.addEventListener("input", (e) => {
        wordCountDisplay.textContent = `${e.target.value} words`;
        if (generatedPassword.value) {
          generateBtn.click(); // Auto-regenerate if password exists
        }
      });

      passwordLength.addEventListener("input", (e) => {
        passwordLengthDisplay.textContent =
          `${e.target.value} characters`;
        if (generatedPassword.value) {
          generateBtn.click(); // Auto-regenerate if password exists
        }
      });

      // Auto-regenerate on checkbox change for random passwords
      const checkboxes = randomOptions.querySelectorAll(
        'input[type="checkbox"]',
      );
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          // Show/hide excluded symbols section based on symbols checkbox
          if (checkbox.id === "includeSymbols") {
            excludedSymbolsSection.style.display = checkbox.checked
              ? "block"
              : "none";
          }

          if (
            currentPasswordType === "random" && generatedPassword.value
          ) {
            generateBtn.click();
          }
        });
      });

      // Load saved excluded symbols
      excludedSymbolsInput.value = getExcludedSymbols();

      // Save excluded symbols on change
      excludedSymbolsInput.addEventListener("input", (e) => {
        setExcludedSymbols(e.target.value);
        if (
          currentPasswordType === "random" && generatedPassword.value &&
          includeSymbolsCheckbox.checked
        ) {
          generateBtn.click(); // Regenerate with new exclusions
        }
      });

      // Show excluded symbols section if symbols are enabled
      if (includeSymbolsCheckbox.checked) {
        excludedSymbolsSection.style.display = "block";
      }

      // Generate password
      generateBtn.addEventListener("click", () => {
        let config;

        if (currentPasswordType === "diceware") {
          config = {
            type: "diceware",
            length: parseInt(wordCount.value),
          };
        } else {
          config = {
            type: "random",
            length: parseInt(passwordLength.value),
            includeUppercase:
              document.getElementById("includeUppercase").checked,
            includeLowercase:
              document.getElementById("includeLowercase").checked,
            includeNumbers:
              document.getElementById("includeNumbers").checked,
            includeSymbols:
              document.getElementById("includeSymbols").checked,
          };
        }

        try {
          const password = generatePassword(config);
          generatedPassword.value = password;

          // Calculate strength using the same analyzer as the main form
          const strength = analyzePasswordStrength(password);
          const strengthLevel = getStrengthLevel(strength.score);

          const strengthText = `Entropy: ${
            Math.round(strength.entropy)
          } bits - ${strengthLevel.label}`;

          generatedPasswordStrength.textContent = strengthText;
          copyGeneratedPassword.disabled = false;
          usePasswordBtn.disabled = false;
        } catch (error) {
          showMessageBox(
            "Password generation error: " + error.message,
            true,
          );
        }
      });

      // Copy generated password
      copyGeneratedPassword.addEventListener("click", () => {
        generatedPassword.select();
        document.execCommand("copy");
        showMessageBox("Password copied!");
      });

      // Use generated password
      usePasswordBtn.addEventListener("click", () => {
        keyInput.value = generatedPassword.value;
        keyInput.type = "text"; // Show the password
        toggleIcon.classList.remove("ph-eye");
        toggleIcon.classList.add("ph-eye-slash");
        togglePassword.classList.add("show");
        passwordGeneratorModal.classList.add("hidden");

        // Trigger input event to update strength indicator
        updateStrengthIndicator(generatedPassword.value);

        showMessageBox("Password set!");
      });

      // NEW: Check for URL parameters on page load
      document.addEventListener("DOMContentLoaded", async () => {
        // Initialize diceware wordlist
        await initializeDiceware();

        // Check for sharing UI mode
        const suiParam = getQueryParam("sui");
        if (suiParam === "1") {
          sharingUIMode = true;

          // Hide password generator button
          const generateBtn = document.getElementById(
            "generatePasswordBtn",
          );
          if (generateBtn) generateBtn.style.display = "none";

          // The strength indicator and breach warnings will be hidden by the flag checks
        }

        const urlPayload = getQueryParam("payload");
        if (urlPayload) {
          try {
            // Simple URL decoding (since database now uses standard URLEncode)
            const decodedPayload = decodeURIComponent(urlPayload);

            payloadInput.value = decodedPayload;
            console.log(
              "Payload populated from URL parameter:",
              decodedPayload.substring(0, 20) + "...",
            );

            // Show a message that payload was loaded
            showMessageBox("Payload loaded from URL parameter"); // For English
            // showMessageBox('URLパラメータからペイロードが読み込まれました'); // For Japanese
          } catch (error) {
            console.error("Error decoding payload parameter:", error);
            showMessageBox("Invalid payload parameter in URL", true); // For English
            // showMessageBox('URLパラメータのペイロードが無効です', true); // For Japanese
          }
        }

        // Intentionally NOT loading key from URL for security reasons
        // Keys should be transmitted separately (email, phone, etc.)
      });

      // QR Code functionality
      window.showQRCodeFromButton = function (event) {
        const url = event.currentTarget.dataset.qrUrl;
        window.showQRCode(url);
      };

      window.showQRCode = function (url) {
        // Create modal if it doesn't exist
        let qrModal = document.getElementById("qrModal");
        if (!qrModal) {
          qrModal = document.createElement("div");
          qrModal.id = "qrModal";
          qrModal.className =
            "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50";
          qrModal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
              <div class="mt-3 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">QR Code</h3>
                <div id="qrCodeContainer" class="flex justify-center mb-4"></div>
                <p class="text-sm text-gray-600 mb-4">Scan with your smartphone to open encrypted content</p>
                <button id="downloadQR" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition mr-2">
                  Save as Image
                </button>
                <button onclick="document.getElementById('qrModal').classList.add('hidden')" 
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition">
                  Close
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(qrModal);
        }

        // Load QR code library if not already loaded
        if (typeof qrcode === "undefined") {
          const script = document.createElement("script");
          script.src =
            "https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js";
          script.onload = function () {
            generateAndShowQR(url);
          };
          document.head.appendChild(script);
        } else {
          generateAndShowQR(url);
        }
      };

      function generateAndShowQR(url) {
        const qrModal = document.getElementById("qrModal");
        const container = document.getElementById("qrCodeContainer");

        // Clear previous QR code
        container.innerHTML = "";

        // Generate QR code
        const typeNumber = 0; // Auto-detect
        const errorCorrectionLevel = "M"; // 15% error correction
        const qr = qrcode(typeNumber, errorCorrectionLevel);
        qr.addData(url);
        qr.make();

        // Create canvas
        const size = 280;
        const cellSize = size / qr.getModuleCount();
        const margin = cellSize * 2;

        const canvas = document.createElement("canvas");
        canvas.width = size + margin * 2;
        canvas.height = size + margin * 2;

        const ctx = canvas.getContext("2d");

        // White background
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw QR code
        ctx.fillStyle = "#000000";
        for (let row = 0; row < qr.getModuleCount(); row++) {
          for (let col = 0; col < qr.getModuleCount(); col++) {
            if (qr.isDark(row, col)) {
              ctx.fillRect(
                margin + col * cellSize,
                margin + row * cellSize,
                cellSize,
                cellSize,
              );
            }
          }
        }

        container.appendChild(canvas);

        // Set up download button
        const downloadBtn = document.getElementById("downloadQR");
        downloadBtn.onclick = function () {
          const link = document.createElement("a");
          link.download = "salty-qr-code.png";
          link.href = canvas.toDataURL();
          link.click();
        };

        // Show modal
        qrModal.classList.remove("hidden");
      }

      // Close QR modal when clicking outside
      window.addEventListener("click", (event) => {
        const qrModal = document.getElementById("qrModal");
        if (qrModal && event.target === qrModal) {
          qrModal.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
