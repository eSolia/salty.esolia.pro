<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Salty: ブラウザネイティブな安全なテキスト暗号化</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta
      property="og:title"
      content="Salty: Browser-Native Secure Text Encryption"
    >
    <meta property="og:url" content="https://salty.esolia.pro/">
    <meta
      property="og:description"
      content="Salty: Browser-Native Secure Text Encryption"
    >
    <!-- Tailwind CSS - Note: Dynamic CDN doesn't support SRI, consider using a specific version -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Kit - Note: Kits don't support SRI, using crossorigin for CORS -->
    <script
      src="https://kit.fontawesome.com/a2929890a6.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- Fathom - beautiful, simple website analytics -->
    <script
      src="https://cdn.usefathom.com/script.js"
      data-site="SIBMOOOY"
      defer
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- / Fathom -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
      /* IBM Plex Sans JP font */
      @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "IBM Plex Sans JP", sans-serif;
      }
      /* Custom styles for the message box */
      .message-box {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4caf50; /* Green */
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .message-box.show {
        opacity: 1;
      }
      .message-box.error {
        background-color: #f44336; /* Red */
      }

      /* Modal styles */
      .modal {
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* Password visibility toggle */
      #togglePassword {
        display: none;
      }
      #togglePassword.show {
        display: block;
      }

      /* Password generator modal styles */
      .password-type-btn {
        cursor: pointer;
      }
      .password-type-btn.active {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .password-type-btn.active i {
        color: #3b82f6;
      }

      /* Password strength indicator styles */
      .strength-meter {
        height: 6px;
        background-color: #e5e7eb;
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .strength-meter-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease, background-color 0.3s ease;
        border-radius: 3px;
      }
      .strength-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 0.875rem;
      }
      .strength-label {
        font-weight: 600;
        transition: color 0.3s ease;
      }
      .strength-details {
        margin-top: 8px;
        padding: 12px;
        background-color: #f9fafb;
        border-radius: 6px;
        font-size: 0.875rem;
        border: 1px solid #e5e7eb;
      }
      .strength-warning {
        color: #dc2626;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .strength-suggestions {
        margin-top: 8px;
      }
      .strength-suggestions ul {
        list-style-type: disc;
        margin-left: 20px;
        color: #6b7280;
      }
      .strength-suggestions li {
        margin-top: 4px;
      }
      /* Breach warning styles */
      .breach-warning {
        margin-top: 12px;
        padding: 12px;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        display: flex;
        align-items: start;
        gap: 8px;
      }
      .breach-warning-icon {
        color: #dc2626;
        font-size: 1.25rem;
        flex-shrink: 0;
      }
      .breach-warning-content {
        flex: 1;
      }
      .breach-warning-title {
        color: #dc2626;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .breach-warning-text {
        color: #7f1d1d;
        font-size: 0.875rem;
        line-height: 1.4;
      }
      .breach-check-loading {
        margin-top: 8px;
        font-size: 0.875rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    </style>
  </head>

  <body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">
    <div id="messageBox" class="message-box"></div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal hidden">
      <div class="modal-content max-w-[65ch] mx-auto">
        <span class="close-button">&times;</span>
        <h1 class="text-3xl font-bold mb-4">Salty</h1>
        <p class="italic mb-4">ブラウザネイティブな安全なテキスト暗号化</p>
        <p class="mb-4">
          Saltyは、共有キーで強力に暗号化されたメッセージを簡単に送信できるようにします。ブラウザのWeb
          Crypto API（Web暗号化API）を介して暗号化機能を提供し、<a
            href="http://base91.sourceforge.net"
            target="_blank"
            class="text-sky-600 hover:underline"
          >basE91</a>を使用して移植性を高めています。
        </p>
        <p class="mb-4">
          Saltyを使えば、最大185文字のメッセージを暗号化でき、結果として得られる暗号文はツイート（約277文字）に収まるため、ツイートや文字数制限のある他の通信の暗号化に最適です。ただし、任意の長さのテキストでもどこでも使用できます。
        </p>
        <h2 class="text-2xl font-semibold mb-3">謝辞</h2>
        <p class="mb-4">
          Saltyは最新のTypeScript言語にて再開発されましたが、<a
            href="http://github.com/neatnik/salty"
            target="_blank"
            class="text-sky-600 hover:underline"
          >NeatnikのPHP版Salty</a>に影響を受けています。
        </p>
      </div>
    </div>

    <!-- Password Generator Modal -->
    <div id="passwordGeneratorModal" class="modal hidden">
      <div class="modal-content" style="max-width: 500px">
        <span
          class="close-button"
          onclick="document.getElementById('passwordGeneratorModal').classList.add('hidden')"
        >&times;</span>
        <h2 class="text-3xl font-bold text-sky-700 mb-6">パスワード生成</h2>

        <div class="mb-6">
          <label class="block text-lg font-semibold text-gray-700 mb-3"
          >タイプ</label>
          <div class="grid grid-cols-2 gap-3">
            <button
              type="button"
              id="dicewareBtn"
              class="password-type-btn active p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center transition"
            >
              <i class="fas fa-dice text-2xl mb-2 text-blue-600"></i>
              <div class="font-semibold">Diceware</div>
              <div class="text-sm text-gray-600">
                覚えやすい単語の組み合わせ
              </div>
            </button>
            <button
              type="button"
              id="randomBtn"
              class="password-type-btn p-4 border-2 border-gray-300 bg-white rounded-lg text-center transition hover:border-gray-400"
            >
              <i class="fas fa-random text-2xl mb-2 text-gray-600"></i>
              <div class="font-semibold">ランダム</div>
              <div class="text-sm text-gray-600">完全にランダムな文字列</div>
            </button>
          </div>
        </div>

        <!-- Diceware Options -->
        <div id="dicewareOptions" class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2"
          >単語数</label>
          <input
            type="range"
            id="wordCount"
            min="4"
            max="8"
            value="6"
            class="w-full"
          >
          <div class="flex justify-between text-sm text-gray-500">
            <span>4</span>
            <span id="wordCountDisplay" class="font-medium text-gray-700"
            >6 単語</span>
            <span>8</span>
          </div>
        </div>

        <!-- Random Options -->
        <div id="randomOptions" class="mb-6 hidden">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
            >長さ</label>
            <input
              type="range"
              id="passwordLength"
              min="8"
              max="32"
              value="16"
              class="w-full"
            >
            <div class="flex justify-between text-sm text-gray-500">
              <span>8</span>
              <span id="passwordLengthDisplay" class="font-medium text-gray-700"
              >16 文字</span>
              <span>32</span>
            </div>
          </div>

          <div class="space-y-2">
            <label class="flex items-center">
              <input type="checkbox" id="includeUppercase" checked class="mr-2">
              <span class="text-sm">大文字 (A-Z)</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="includeLowercase" checked class="mr-2">
              <span class="text-sm">小文字 (a-z)</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="includeNumbers" checked class="mr-2">
              <span class="text-sm">数字 (0-9)</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="includeSymbols" checked class="mr-2">
              <span class="text-sm">記号 (!@#$%^&*)</span>
            </label>
          </div>

          <!-- Excluded Symbols -->
          <div class="mt-4" id="excludedSymbolsSection" style="display: none">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              除外する記号
              <span class="text-xs text-gray-500 ml-1">
                (モバイルで入力しにくい文字など)
              </span>
            </label>
            <input
              type="text"
              id="excludedSymbols"
              class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-mono"
              placeholder="例: <>{}"
            >
            <p class="text-xs text-gray-500 mt-1">
              ここに入力した記号はパスワード生成時に使用されません
            </p>
          </div>
        </div>

        <!-- Generated Password Display -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2"
          >生成されたパスワード</label>
          <div
            class="relative bg-gray-50 p-4 rounded-lg border border-gray-300"
          >
            <input
              type="text"
              id="generatedPassword"
              readonly
              class="w-full bg-transparent border-none outline-none pr-20 font-mono"
              placeholder="生成ボタンをクリック"
            >
            <button
              type="button"
              id="copyGeneratedPassword"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              コピー
            </button>
          </div>
          <div
            id="generatedPasswordStrength"
            class="mt-2 text-sm text-gray-600"
          >
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
          <button
            type="button"
            id="generateBtn"
            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-medium"
          >
            <i class="fas fa-sync-alt mr-2"></i>生成
          </button>
          <button
            type="button"
            id="usePasswordBtn"
            class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <i class="fas fa-check mr-2"></i>使用
          </button>
        </div>
      </div>
    </div>

    <header class="bg-sky-800 text-white p-4 shadow-md">
      <div class="container mx-auto flex justify-between items-center">
        <p class="flex items-center space-x-2">
          <a
            href="/"
            class="text-white hover:text-gray-300 font-bold text-lg rounded-md p-1 transition"
          >
            <img
              src="/img/symbol_white_bgtransparent.svg"
              alt="イソリア シンボル ロゴ"
              class="h-10 w-auto rounded-md"
            >
          </a>
        </p>
        <p class="flex items-center space-x-4">
          <strong class="text-gray-300">表示言語:</strong>
          <a
            href="/en/"
            class="text-white hover:text-gray-300 font-bold rounded-md p-2 hover:bg-gray-700 transition"
          >English</a>
          <a
            href="/"
            class="text-white hover:text-gray-300 font-bold rounded-md p-2 hover:bg-gray-700 transition"
          >日本語</a>
        </p>
      </div>
    </header>

    <main class="container mx-auto p-6 flex-grow">
      <h1 class="text-4xl font-bold text-center text-sky-700 mb-8 mt-4">
        Salty 安全なテキスト暗号化
      </h1>

      <p class="max-w-[65ch] mx-auto text-center text-lg mb-8 leading-relaxed">
        下記にペイロードとキーをご記入して、「実行」をクリックしてください。<br>ペイロードは、暗号化されていないテキスト、またはSaltyで暗号化（自動的に検出）することができます。
      </p>

      <form
        id="saltyForm"
        method="POST"
        class="bg-white p-8 rounded-lg shadow-xl max-w-2xl mx-auto space-y-6 border border-blue-200"
      >
        <div>
          <label
            for="payload"
            class="block text-lg font-semibold text-gray-700 mb-2"
          >ペイロード</label>
          <textarea
            name="payload"
            id="payload"
            rows="8"
            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 text-base resize-y"
          ></textarea>
        </div>

        <div>
          <div class="flex justify-between items-end mb-2">
            <label
              for="key"
              class="block text-lg font-semibold text-gray-700"
            >キー</label>
            <button
              type="button"
              id="generatePasswordBtn"
              class="text-sm text-blue-600 hover:text-blue-700 font-medium"
            >
              <i class="fas fa-key mr-1"></i>パスワード生成
            </button>
          </div>
          <div class="relative">
            <input
              type="password"
              name="key"
              id="key"
              class="w-full p-4 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 text-base"
              placeholder="暗号化/復号のためのキーを入力"
            >
            <button
              type="button"
              id="togglePassword"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
              aria-label="パスワードを表示/非表示"
            >
              <i class="fas fa-eye" id="toggleIcon"></i>
            </button>
          </div>
          <!-- Password strength indicator -->
          <div id="strengthIndicator" class="hidden">
            <div class="strength-meter">
              <div id="strengthMeterFill" class="strength-meter-fill"></div>
            </div>
            <div class="strength-info">
              <span id="strengthLabel" class="strength-label"></span>
              <span id="entropyInfo" class="text-gray-500"></span>
            </div>
            <div id="strengthDetails" class="strength-details hidden">
              <div id="strengthWarning" class="strength-warning"></div>
              <div id="strengthCrackTime" class="text-gray-600 mb-2"></div>
              <div id="strengthSuggestions" class="strength-suggestions"></div>
            </div>
          </div>
          <!-- Breach warning -->
          <div id="breachWarning" class="breach-warning hidden">
            <div class="breach-warning-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="breach-warning-content">
              <div class="breach-warning-title" id="breachTitle"></div>
              <div class="breach-warning-text" id="breachText"></div>
            </div>
          </div>
          <!-- Breach check loading -->
          <div id="breachCheckLoading" class="breach-check-loading hidden">
            <div class="spinner"></div>
            <span>データ侵害をチェック中...</span>
          </div>
        </div>

        <!-- Grouped Go and Reset buttons -->
        <div
          class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6"
        >
          <button
            type="submit"
            class="w-full sm:w-1/2 bg-emerald-500 text-white py-3 px-6 rounded-lg font-semibold text-xl shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-300 ease-in-out transform hover:scale-105"
          >
            実行
          </button>
          <button
            type="button"
            id="resetFormBtn"
            class="w-full sm:w-1/2 bg-amber-500 text-white py-3 px-6 rounded-lg font-semibold text-xl shadow-md hover:bg-amber-600 focus:outline-none focus:ring-4 focus:ring-amber-300 transition duration-300 ease-in-out transform hover:scale-105"
          >
            リセット
          </button>
        </div>
      </form>

      <div
        id="saltyResult"
        class="mt-12 bg-white p-8 rounded-lg shadow-xl max-w-2xl mx-auto border border-blue-200 hidden"
      >
        <!-- Results will be displayed here by JavaScript -->
      </div>
    </main>

    <footer class="bg-sky-800 text-white p-6 mt-8 shadow-inner">
      <div class="container mx-auto text-center">
        <h4 class="text-xl font-semibold mb-3">株式会社イソリア</h4>
        <p class="mb-2">
          〒105-7105 東京都港区東新橋一丁目５番２号<br>汐留シティセンター５階
          （Work Styling）
        </p>
        <p class="mb-4">Tel: 03-4577-3380 (代表)<br>Fax: 03-4577-3309</p>
        <img
          src="/img/logo_horiz_white_bgtransparent.svg"
          alt="イソリア ロゴ"
          class="mx-auto mb-4 rounded-md"
        />
        <p>
          <button
            type="button"
            id="aboutSaltyBtn"
            class="bg-fuchsia-600 text-white py-2 px-5 rounded-lg hover:bg-fuchsia-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
          >
            ソルティーについて
          </button>
        </p>
      </div>
    </footer>

    <script type="module">
      // Import cryptographic functions from salty.ts
      import {
        salty_decrypt,
        salty_encrypt,
        salty_key,
      } from "/salty.ts";

      // Import password strength analyzer
      import {
        analyzePasswordStrength,
        getStrengthLevel,
      } from "/password-strength.ts";

      // Import HIBP checker
      import { checkPasswordBreach } from "/hibp-checker.ts";

      // Import password generator
      import {
        calculatePasswordEntropy,
        generatePassword,
        getExcludedSymbols,
        initializeDiceware,
        setExcludedSymbols,
      } from "/password-generator.ts";

      // This will be replaced by the server upon serving the HTML file.
      const INJECTED_SALT_HEX =
        "SALT_HEX_PLACEHOLDER_INJECTED_BY_SERVER";

      const saltyForm = document.getElementById("saltyForm");
      const payloadInput = document.getElementById("payload");
      const keyInput = document.getElementById("key");
      const saltyResultDiv = document.getElementById("saltyResult");
      const messageBox = document.getElementById("messageBox");
      const aboutSaltyBtn = document.getElementById("aboutSaltyBtn");
      const helpModal = document.getElementById("helpModal");
      const closeButton = helpModal.querySelector(".close-button");
      const resetFormBtn = document.getElementById("resetFormBtn"); // Get the new reset button
      const togglePassword = document.getElementById("togglePassword");
      const toggleIcon = document.getElementById("toggleIcon");

      // Password strength indicator elements
      const strengthIndicator = document.getElementById(
        "strengthIndicator",
      );
      const strengthMeterFill = document.getElementById(
        "strengthMeterFill",
      );
      const strengthLabel = document.getElementById("strengthLabel");
      const entropyInfo = document.getElementById("entropyInfo");
      const strengthDetails = document.getElementById(
        "strengthDetails",
      );
      const strengthWarning = document.getElementById(
        "strengthWarning",
      );
      const strengthCrackTime = document.getElementById(
        "strengthCrackTime",
      );
      const strengthSuggestions = document.getElementById(
        "strengthSuggestions",
      );

      // Breach warning elements
      const breachWarning = document.getElementById("breachWarning");
      const breachTitle = document.getElementById("breachTitle");
      const breachText = document.getElementById("breachText");
      const breachCheckLoading = document.getElementById(
        "breachCheckLoading",
      );

      /**
       * Japanese translations for password strength labels and messages
       */
      const strengthTranslations = {
        labels: {
          "Very Weak": "非常に弱い",
          "Weak": "弱い",
          "Fair": "普通",
          "Good": "良い",
          "Strong": "強い",
        },
        warnings: {
          "Avoid using 'password' or similar":
            "「password」などの使用は避けてください",
          "Common word detected - easily guessable":
            "一般的な単語 - 推測されやすい",
          "Only numbers - very predictable":
            "数字のみ - 非常に予測しやすい",
          "Only lowercase letters - limited character set":
            "小文字のみ - 文字セットが限定的",
          "Repeated characters reduce security":
            "繰り返し文字はセキュリティを低下させます",
          "Very predictable - easily crackable":
            "非常に予測しやすい - 簡単に解読可能",
          "Could be cracked with moderate effort":
            "中程度の努力で解読可能",
        },
        suggestions: {
          "Use at least 8 characters": "8文字以上使用してください",
          "Consider using 12+ characters for better security":
            "より良いセキュリティのため12文字以上を検討してください",
          "Add lowercase letters": "小文字を追加してください",
          "Add uppercase letters": "大文字を追加してください",
          "Add numbers": "数字を追加してください",
          "Add special characters (!@#$%^&*)":
            "特殊文字を追加してください (!@#$%^&*)",
          "Excellent password strength!": "優れたパスワード強度です！",
        },
        crackTime: {
          "instant": "瞬時",
          "< 1 minute": "1分以内",
          "minutes": "分",
          "hours": "時間",
          "days": "日",
          "months": "ヶ月",
          "years": "年",
          "k years": "千年",
          "M years": "百万年",
          "centuries": "数世紀",
        },
        info: {
          "entropy": "エントロピー",
          "bits": "ビット",
          "crackTime": "解読時間",
        },
        breach: {
          "title": "このパスワードは侵害されています！",
          "singleBreach":
            "このパスワードは1件のデータ侵害で発見されました。",
          "multipleBreach":
            "このパスワードは{count}件のデータ侵害で発見されました。",
          "recommendation":
            "別のユニークなパスワードを選択することを強く推奨します。",
          "checkError": "侵害チェックに失敗しました: {error}",
          "checking": "データ侵害をチェック中...",
        },
      };

      /**
       * Translate strength-related text to Japanese
       */
      function translateStrength(text, category) {
        if (category === "crackTime") {
          // Handle crack time translations
          for (
            const [en, ja] of Object.entries(
              strengthTranslations.crackTime,
            )
          ) {
            if (text === en) return ja;
            if (text.includes(en)) {
              const num = text.match(/\d+/);
              if (num) return `${num[0]}${ja}`;
            }
          }
          return text;
        }
        return strengthTranslations[category]?.[text] || text;
      }

      // Debounce timer for breach checking
      let breachCheckTimer = null;

      /**
       * Check password breach status with debouncing
       */
      async function checkBreachStatus(password) {
        if (!password || password.length < 8) {
          breachWarning.classList.add("hidden");
          breachCheckLoading.classList.add("hidden");
          return;
        }

        // Show loading state
        breachCheckLoading.classList.remove("hidden");
        breachWarning.classList.add("hidden");

        try {
          const result = await checkPasswordBreach(password);

          // Hide loading
          breachCheckLoading.classList.add("hidden");

          if (result.error) {
            // Don't show errors to avoid blocking user
            console.warn("Breach check error:", result.error);
            return;
          }

          if (result.isCompromised) {
            breachTitle.textContent = strengthTranslations.breach.title;

            const breachMessage = result.breachCount === 1
              ? strengthTranslations.breach.singleBreach
              : strengthTranslations.breach.multipleBreach.replace(
                "{count}",
                result.breachCount.toLocaleString(),
              );

            breachText.textContent =
              `${breachMessage} ${strengthTranslations.breach.recommendation}`;
            breachWarning.classList.remove("hidden");
          } else {
            breachWarning.classList.add("hidden");
          }
        } catch (error) {
          // Hide loading on error
          breachCheckLoading.classList.add("hidden");
          console.error("Breach check failed:", error);
        }
      }

      /**
       * Update password strength indicator
       */
      function updateStrengthIndicator(password) {
        if (!password) {
          strengthIndicator.classList.add("hidden");
          return;
        }

        strengthIndicator.classList.remove("hidden");

        // Check if this is a generated password with metadata
        const isDiceware = keyInput.dataset.isDiceware === "true";
        const wordCount = parseInt(keyInput.dataset.wordCount);

        let strength;
        if (isDiceware && wordCount) {
          // For diceware, calculate entropy properly
          const entropy = calculatePasswordEntropy(
            password,
            true,
            wordCount,
          );
          // Create a strength object compatible with analyzePasswordStrength output
          strength = {
            score: entropy >= 100
              ? 4
              : entropy >= 80
              ? 3
              : entropy >= 60
              ? 2
              : entropy >= 40
              ? 1
              : 0,
            entropy: entropy,
            feedback: {
              warning: "",
              suggestions: entropy >= 80
                ? ["Excellent password strength!"]
                : [],
            },
            crackTimeDisplay: entropy >= 100
              ? "centuries"
              : entropy >= 80
              ? "years"
              : entropy >= 60
              ? "months"
              : entropy >= 40
              ? "days"
              : "hours",
          };
        } else {
          strength = analyzePasswordStrength(password);
        }

        const level = getStrengthLevel(strength.score);

        // Update meter fill
        const percentage = (strength.score / 4) * 100;
        strengthMeterFill.style.width = `${percentage}%`;
        strengthMeterFill.style.backgroundColor = level.color;

        // Update labels
        strengthLabel.textContent = translateStrength(
          level.label,
          "labels",
        );
        strengthLabel.style.color = level.color;
        entropyInfo.textContent =
          `${strengthTranslations.info.entropy}: ${
            Math.round(strength.entropy)
          } ${strengthTranslations.info.bits}`;

        // Update details
        if (
          strength.feedback.warning ||
          strength.feedback.suggestions.length > 0 || strength.score < 4
        ) {
          strengthDetails.classList.remove("hidden");

          // Warning
          if (strength.feedback.warning) {
            strengthWarning.textContent = translateStrength(
              strength.feedback.warning,
              "warnings",
            );
            strengthWarning.style.display = "block";
          } else {
            strengthWarning.style.display = "none";
          }

          // Crack time
          const translatedCrackTime = translateStrength(
            strength.crackTimeDisplay,
            "crackTime",
          );
          strengthCrackTime.textContent =
            `${strengthTranslations.info.crackTime}: ${translatedCrackTime}`;

          // Suggestions
          if (strength.feedback.suggestions.length > 0) {
            const suggestionsList = strength.feedback.suggestions
              .map((s) =>
                `<li>${translateStrength(s, "suggestions")}</li>`
              )
              .join("");
            strengthSuggestions.innerHTML =
              `<ul>${suggestionsList}</ul>`;
            strengthSuggestions.style.display = "block";
          } else {
            strengthSuggestions.style.display = "none";
          }
        } else {
          strengthDetails.classList.add("hidden");
        }
      }

      /**
       * Displays a temporary message box for user feedback.
       * @param {string} message The message to display.
       * @param {boolean} isError True if it's an error message, false for success/info.
       */
      function showMessageBox(message, isError = false) {
        messageBox.textContent = message;
        messageBox.className = "message-box show"; // Reset classes
        if (isError) {
          messageBox.classList.add("error");
        }
        setTimeout(() => {
          messageBox.classList.remove("show");
        }, 3000); // Hide after 3 seconds
      }

      /**
       * Copies text to the clipboard.
       * Reads the text from a data attribute on the clicked element.
       * @param {Event} event The click event.
       */
      window.copyToClipboard = function (event) { // Attached to window object
        const textToCopy = event.currentTarget.dataset.textToCopy;
        if (!textToCopy) {
          showMessageBox("コピーするテキストがありません。", true);
          return;
        }

        const textarea = document.createElement("textarea");
        textarea.value = textToCopy;
        textarea.style.position = "fixed"; // Avoid scrolling to bottom
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.focus(); // Ensure textarea is focused
        textarea.select();
        try {
          const successful = document.execCommand("copy");
          if (successful) {
            showMessageBox("クリップボードにコピーしました！");
          } else {
            showMessageBox(
              "クリップボードへのコピーに失敗しました。",
              true,
            );
          }
        } catch (err) {
          showMessageBox(
            "クリップボードへのコピーに失敗しました。",
            true,
          );
        }
        document.body.removeChild(textarea);
      };

      // Function to format and display output
      function displayResult(type, content) {
        let html = "";
        saltyResultDiv.innerHTML = ""; // Clear previous results
        saltyResultDiv.classList.remove("hidden");

        if (type === "plaintext") {
          html +=
            `<p class="text-sm text-gray-500 mb-2"><span class="font-bold text-green-600">自動検出: プレーンテキスト</span></p>`;
          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4">共有可能暗号テキスト</h3>`;
          html +=
            `<div class="relative bg-amber-50 p-4 rounded-lg border border-blue-200 mb-4">
                  <p class="output uncompressed break-all text-gray-800">${
              escapeHtml(content.encryptedFormatted)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(content.encryptedFormatted)
            }"
                          class="absolute top-2 right-2 bg-amber-200 text-sky-800 px-3 py-1 rounded-md text-xs hover:bg-amber-300 transition">
                    コピー
                  </button>
               </div>`;

          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4">共有可能暗号テキスト（圧縮版）</h3>`;
          html +=
            `<div class="relative bg-amber-50 p-4 rounded-lg border border-blue-200">
                  <p class="output breakable compressed text-gray-800 break-words">${
              escapeHtml(content.encryptedCompressed)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(content.encryptedCompressed)
            }"
                          class="absolute top-2 right-2 bg-amber-200 text-sky-800 px-3 py-1 rounded-md text-xs hover:bg-amber-300 transition">
                    コピー
                  </button>
               </div>
               <p class="text-sm text-gray-500 mt-2">${content.encryptedCompressed.length} chars</p>`;

          // Add URL copy button
          const currentUrl = new URL(window.location.href);
          currentUrl.searchParams.set(
            "payload",
            encodeURIComponent(content.encryptedCompressed),
          );
          const shareableUrl = currentUrl.toString();

          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4 mt-6">共有可能URL</h3>`;
          html +=
            `<div class="relative bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <p class="output text-gray-800 break-all text-sm">${
              escapeHtml(shareableUrl)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(shareableUrl)
            }"
                          class="absolute top-2 right-2 bg-blue-200 text-blue-800 px-3 py-1 rounded-md text-xs hover:bg-blue-300 transition">
                    URLをコピー
                  </button>
               </div>
               <p class="text-sm text-gray-500 mt-2">このURLを共有することで、受信者は同じキーを使って復号できます。</p>`;

          // Add QR code section
          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4 mt-6">QRコード</h3>`;
          html +=
            `<div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 text-center">
                  <button onclick="window.showQRCodeFromButton(event)" 
                          data-qr-url="${escapeHtml(shareableUrl)}"
                          class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    QRコードを表示
                  </button>
                  <p class="text-sm text-gray-600 mt-2">スマートフォンでスキャンして<br>暗号化コンテンツを開きます</p>
               </div>`;
        } else if (type === "encrypted") {
          html +=
            `<p class="text-sm text-gray-500 mb-2"><span class="font-bold text-purple-600">自動検出: Salty暗号化テキスト</span></p>`;
          html +=
            `<h3 class="text-2xl font-semibold text-sky-700 mb-4">復号の結果</h3>`;
          html +=
            `<div class="relative bg-green-50 p-4 rounded-lg border border-green-200">
                  <p class="output decrypted break-all text-gray-800">${
              escapeHtml(content.decrypted)
            }</p>
                  <button onclick="window.copyToClipboard(event)" data-text-to-copy="${
              escapeHtml(content.decrypted)
            }"
                          class="absolute top-2 right-2 bg-green-200 text-green-800 px-3 py-1 rounded-md text-xs hover:bg-green-300 transition">
                    コピー
                  </button>
               </div>`;
        } else if (type === "error") {
          html +=
            `<p class="text-sm text-red-500 mb-2"><span class="font-bold">エラー</span></p>`;
          html +=
            `<div class="bg-red-50 p-4 rounded-lg border border-red-200 text-red-700">
                    <p>${escapeHtml(content)}</p>
                 </div>`;
        }
        saltyResultDiv.innerHTML = html;
      }

      // Basic HTML escaping
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
          "`": "&#96;", // Escape backtick for safety in template literals
        };
        return text.replace(/[&<>"'`]/g, function (m) {
          return map[m];
        });
      }

      // Function to get query parameter by name
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Event listener for form submission
      saltyForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = payloadInput.value;
        const key = keyInput.value;

        if (!payload || !key) {
          displayResult(
            "error",
            "ペイロードとキーの両方を入力してください。",
          );
          return;
        }

        try {
          const cryptoKey = await salty_key(key, INJECTED_SALT_HEX);

          // Step 1: Clean the input by removing potential Salty headers and spaces
          let cleanedPayload = payload
            .replace(/-- BEGIN SALTY ENCRYPTED MESSAGE --/g, "")
            .replace(/-- END SALTY ENCRYPTED MESSAGE --/g, "")
            .replace(/\n|\r| /g, "");

          let decryptedText = null;
          try {
            decryptedText = await salty_decrypt(
              cleanedPayload,
              cryptoKey,
            );
          } catch (e) {
            console.warn(
              "Decryption attempt threw an error (likely invalid ciphertext format for Web Crypto API):",
              e,
            );
            // If salty_decrypt throws, it's definitely not valid ciphertext for the key, proceed to encrypt.
          }

          if (decryptedText !== null && decryptedText !== "") { // Also check for non-empty decrypted text
            // If decryption was successful and returned non-empty text, display it as decrypted.
            displayResult("encrypted", { decrypted: decryptedText });
          } else {
            // If decryption failed or returned null/empty, assume it was plaintext and encrypt it.
            // Use the original payload for encryption, not the cleaned one.
            const encrypted = await salty_encrypt(payload, cryptoKey);

            const encryptedFormatted =
              "-- BEGIN SALTY ENCRYPTED MESSAGE --\n" +
              encrypted.match(/.{1,2}/g)?.join(" ") +
              "\n-- END SALTY ENCRYPTED MESSAGE --";

            displayResult("plaintext", {
              encryptedFormatted: encryptedFormatted,
              encryptedCompressed: encrypted,
            });
          }
        } catch (e) {
          console.error("Overall operation failed:", e);
          displayResult(
            "error",
            "エラーが発生しました: " + (e.message || "不明なエラー"),
          );
        }
      });

      // Event listener for password strength indicator and breach check
      keyInput.addEventListener("input", (event) => {
        const password = event.target.value;

        // Clear diceware metadata if user is typing manually
        // (unless this event was triggered programmatically from the generator)
        if (!event.isTrusted) {
          // This is a programmatic event, keep the metadata
        } else {
          // User is typing, clear metadata
          delete keyInput.dataset.isDiceware;
          delete keyInput.dataset.wordCount;
        }

        updateStrengthIndicator(password);

        // Show/hide password toggle based on input
        if (password.length > 0) {
          togglePassword.classList.add("show");
        } else {
          togglePassword.classList.remove("show");
        }

        // Debounce breach checking (500ms after user stops typing)
        if (breachCheckTimer) {
          clearTimeout(breachCheckTimer);
        }

        if (password.length >= 8) {
          breachCheckTimer = setTimeout(() => {
            checkBreachStatus(password);
          }, 500);
        } else {
          breachWarning.classList.add("hidden");
          breachCheckLoading.classList.add("hidden");
        }
      });

      // Password visibility toggle
      togglePassword.addEventListener("click", () => {
        const type = keyInput.getAttribute("type") === "password"
          ? "text"
          : "password";
        keyInput.setAttribute("type", type);

        // Toggle icon
        if (type === "password") {
          toggleIcon.classList.remove("fa-eye-slash");
          toggleIcon.classList.add("fa-eye");
        } else {
          toggleIcon.classList.remove("fa-eye");
          toggleIcon.classList.add("fa-eye-slash");
        }
      });

      // Event listener for the reset button
      resetFormBtn.addEventListener("click", () => {
        payloadInput.value = "";
        keyInput.value = "";
        saltyResultDiv.classList.add("hidden");
        strengthIndicator.classList.add("hidden");
        breachWarning.classList.add("hidden");
        breachCheckLoading.classList.add("hidden");
        togglePassword.classList.remove("show");

        // Clear breach check timer
        if (breachCheckTimer) {
          clearTimeout(breachCheckTimer);
        }

        // Clear URL parameters
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);

        showMessageBox("フォームをリセットしました。");
      });

      // Handle the "About Salty" button click to open modal
      aboutSaltyBtn.addEventListener("click", () => {
        helpModal.classList.remove("hidden");
      });

      // Handle closing the modal
      closeButton.addEventListener("click", () => {
        helpModal.classList.add("hidden");
      });

      // Close modal if user clicks outside of it
      window.addEventListener("click", (event) => {
        if (event.target === helpModal) {
          helpModal.classList.add("hidden");
        }
        if (
          event.target ===
            document.getElementById("passwordGeneratorModal")
        ) {
          document.getElementById("passwordGeneratorModal").classList
            .add("hidden");
        }
      });

      // Password Generator functionality
      const passwordGeneratorModal = document.getElementById(
        "passwordGeneratorModal",
      );
      const generatePasswordBtn = document.getElementById(
        "generatePasswordBtn",
      );
      const dicewareBtn = document.getElementById("dicewareBtn");
      const randomBtn = document.getElementById("randomBtn");
      const dicewareOptions = document.getElementById(
        "dicewareOptions",
      );
      const randomOptions = document.getElementById("randomOptions");
      const wordCount = document.getElementById("wordCount");
      const wordCountDisplay = document.getElementById(
        "wordCountDisplay",
      );
      const passwordLength = document.getElementById("passwordLength");
      const passwordLengthDisplay = document.getElementById(
        "passwordLengthDisplay",
      );
      const generatedPassword = document.getElementById(
        "generatedPassword",
      );
      const generatedPasswordStrength = document.getElementById(
        "generatedPasswordStrength",
      );
      const copyGeneratedPassword = document.getElementById(
        "copyGeneratedPassword",
      );
      const generateBtn = document.getElementById("generateBtn");
      const usePasswordBtn = document.getElementById("usePasswordBtn");
      const excludedSymbolsInput = document.getElementById(
        "excludedSymbols",
      );
      const excludedSymbolsSection = document.getElementById(
        "excludedSymbolsSection",
      );
      const includeSymbolsCheckbox = document.getElementById(
        "includeSymbols",
      );

      let currentPasswordType = "diceware";

      // Open password generator modal
      generatePasswordBtn.addEventListener("click", () => {
        passwordGeneratorModal.classList.remove("hidden");
        generateBtn.click(); // Auto-generate on open
      });

      // Switch between diceware and random
      dicewareBtn.addEventListener("click", () => {
        if (currentPasswordType !== "diceware") {
          currentPasswordType = "diceware";
          dicewareBtn.classList.add(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          dicewareBtn.classList.remove("border-gray-300", "bg-white");
          randomBtn.classList.remove(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          randomBtn.classList.add("border-gray-300", "bg-white");
          dicewareOptions.classList.remove("hidden");
          randomOptions.classList.add("hidden");
          generateBtn.click(); // Auto-regenerate on type change
        }
      });

      randomBtn.addEventListener("click", () => {
        if (currentPasswordType !== "random") {
          currentPasswordType = "random";
          randomBtn.classList.add(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          randomBtn.classList.remove("border-gray-300", "bg-white");
          dicewareBtn.classList.remove(
            "active",
            "border-blue-500",
            "bg-blue-50",
          );
          dicewareBtn.classList.add("border-gray-300", "bg-white");
          randomOptions.classList.remove("hidden");
          dicewareOptions.classList.add("hidden");
          generateBtn.click(); // Auto-regenerate on type change
        }
      });

      // Update sliders and auto-regenerate
      wordCount.addEventListener("input", (e) => {
        wordCountDisplay.textContent = `${e.target.value} 単語`;
        if (generatedPassword.value) {
          generateBtn.click(); // Auto-regenerate if password exists
        }
      });

      passwordLength.addEventListener("input", (e) => {
        passwordLengthDisplay.textContent = `${e.target.value} 文字`;
        if (generatedPassword.value) {
          generateBtn.click(); // Auto-regenerate if password exists
        }
      });

      // Auto-regenerate on checkbox change for random passwords
      const checkboxes = randomOptions.querySelectorAll(
        'input[type="checkbox"]',
      );
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          // Show/hide excluded symbols section based on symbols checkbox
          if (checkbox.id === "includeSymbols") {
            excludedSymbolsSection.style.display = checkbox.checked
              ? "block"
              : "none";
          }

          if (
            currentPasswordType === "random" && generatedPassword.value
          ) {
            generateBtn.click();
          }
        });
      });

      // Load saved excluded symbols
      excludedSymbolsInput.value = getExcludedSymbols();

      // Save excluded symbols on change
      excludedSymbolsInput.addEventListener("input", (e) => {
        setExcludedSymbols(e.target.value);
        if (
          currentPasswordType === "random" && generatedPassword.value &&
          includeSymbolsCheckbox.checked
        ) {
          generateBtn.click(); // Regenerate with new exclusions
        }
      });

      // Show excluded symbols section if symbols are enabled
      if (includeSymbolsCheckbox.checked) {
        excludedSymbolsSection.style.display = "block";
      }

      // Generate password
      generateBtn.addEventListener("click", () => {
        let config;

        if (currentPasswordType === "diceware") {
          config = {
            type: "diceware",
            length: parseInt(wordCount.value),
          };
        } else {
          config = {
            type: "random",
            length: parseInt(passwordLength.value),
            includeUppercase:
              document.getElementById("includeUppercase").checked,
            includeLowercase:
              document.getElementById("includeLowercase").checked,
            includeNumbers:
              document.getElementById("includeNumbers").checked,
            includeSymbols:
              document.getElementById("includeSymbols").checked,
          };
        }

        try {
          const password = generatePassword(config);
          generatedPassword.value = password;

          // Calculate strength using the same analyzer as the main form
          const strength = analyzePasswordStrength(password);
          const strengthLevel = getStrengthLevel(strength.score);

          const strengthText = `エントロピー: ${
            Math.round(strength.entropy)
          } ビット - ${
            strength.score === 4
              ? "非常に強い"
              : strength.score === 3
              ? "良い"
              : strength.score === 2
              ? "普通"
              : strength.score === 1
              ? "弱い"
              : "非常に弱い"
          }`;

          generatedPasswordStrength.textContent = strengthText;
          copyGeneratedPassword.disabled = false;
          usePasswordBtn.disabled = false;
        } catch (error) {
          showMessageBox(
            "パスワード生成エラー: " + error.message,
            true,
          );
        }
      });

      // Copy generated password
      copyGeneratedPassword.addEventListener("click", () => {
        generatedPassword.select();
        document.execCommand("copy");
        showMessageBox("パスワードをコピーしました！");
      });

      // Use generated password
      usePasswordBtn.addEventListener("click", () => {
        keyInput.value = generatedPassword.value;
        keyInput.type = "text"; // Show the password
        toggleIcon.classList.remove("fa-eye");
        toggleIcon.classList.add("fa-eye-slash");
        togglePassword.classList.add("show");
        passwordGeneratorModal.classList.add("hidden");

        // Store metadata about generated password
        keyInput.dataset.isDiceware =
          currentPasswordType === "diceware";
        keyInput.dataset.wordCount = currentPasswordType === "diceware"
          ? wordCount.value
          : "";

        // Trigger input event to update strength indicator
        keyInput.dispatchEvent(new Event("input"));

        showMessageBox("パスワードが設定されました！");
      });

      // NEW: Check for URL parameters on page load
      document.addEventListener("DOMContentLoaded", async () => {
        // Initialize diceware wordlist
        await initializeDiceware();
        const urlPayload = getQueryParam("payload");
        if (urlPayload) {
          try {
            // Simple URL decoding (since database now uses standard URLEncode)
            const decodedPayload = decodeURIComponent(urlPayload);

            payloadInput.value = decodedPayload;
            console.log(
              "Payload populated from URL parameter:",
              decodedPayload.substring(0, 20) + "...",
            );

            // Show a message that payload was loaded
            // showMessageBox('Payload loaded from URL parameter'); // For English
            showMessageBox(
              "URLパラメータからペイロードが読み込まれました",
            ); // For Japanese
          } catch (error) {
            console.error("Error decoding payload parameter:", error);
            // showMessageBox('Invalid payload parameter in URL', true); // For English
            showMessageBox("URLパラメータのペイロードが無効です", true); // For Japanese
          }
        }

        // Intentionally NOT loading key from URL for security reasons
        // Keys should be transmitted separately (email, phone, etc.)
      });

      // QR Code functionality
      window.showQRCodeFromButton = function (event) {
        const url = event.currentTarget.dataset.qrUrl;
        window.showQRCode(url);
      };

      window.showQRCode = function (url) {
        // Create modal if it doesn't exist
        let qrModal = document.getElementById("qrModal");
        if (!qrModal) {
          qrModal = document.createElement("div");
          qrModal.id = "qrModal";
          qrModal.className =
            "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50";
          qrModal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
              <div class="mt-3 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">QRコード</h3>
                <div id="qrCodeContainer" class="flex justify-center mb-4"></div>
                <p class="text-sm text-gray-600 mb-4">スマートフォンでスキャンして<br>暗号化コンテンツを開きます</p>
                <button id="downloadQR" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition mr-2">
                  画像として保存
                </button>
                <button onclick="document.getElementById('qrModal').classList.add('hidden')" 
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition">
                  閉じる
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(qrModal);
        }

        // Load QR code library if not already loaded
        if (typeof qrcode === "undefined") {
          const script = document.createElement("script");
          script.src =
            "https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js";
          script.onload = function () {
            generateAndShowQR(url);
          };
          document.head.appendChild(script);
        } else {
          generateAndShowQR(url);
        }
      };

      function generateAndShowQR(url) {
        const qrModal = document.getElementById("qrModal");
        const container = document.getElementById("qrCodeContainer");

        // Clear previous QR code
        container.innerHTML = "";

        // Generate QR code
        const typeNumber = 0; // Auto-detect
        const errorCorrectionLevel = "M"; // 15% error correction
        const qr = qrcode(typeNumber, errorCorrectionLevel);
        qr.addData(url);
        qr.make();

        // Create canvas
        const size = 280;
        const cellSize = size / qr.getModuleCount();
        const margin = cellSize * 2;

        const canvas = document.createElement("canvas");
        canvas.width = size + margin * 2;
        canvas.height = size + margin * 2;

        const ctx = canvas.getContext("2d");

        // White background
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw QR code
        ctx.fillStyle = "#000000";
        for (let row = 0; row < qr.getModuleCount(); row++) {
          for (let col = 0; col < qr.getModuleCount(); col++) {
            if (qr.isDark(row, col)) {
              ctx.fillRect(
                margin + col * cellSize,
                margin + row * cellSize,
                cellSize,
                cellSize,
              );
            }
          }
        }

        container.appendChild(canvas);

        // Set up download button
        const downloadBtn = document.getElementById("downloadQR");
        downloadBtn.onclick = function () {
          const link = document.createElement("a");
          link.download = "salty-qr-code.png";
          link.href = canvas.toDataURL();
          link.click();
        };

        // Show modal
        qrModal.classList.remove("hidden");
      }

      // Close QR modal when clicking outside
      window.addEventListener("click", (event) => {
        const qrModal = document.getElementById("qrModal");
        if (qrModal && event.target === qrModal) {
          qrModal.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
